<script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>

<style>
    /* Aesthetic Overrides */
    .soft-glow { box-shadow: 0 20px 40px -15px rgba(0, 0, 0, 0.1); }
    .tox-tinymce { border: none !important; border-radius: 1rem !important; }
    .tox .tox-toolbar__primary { background: transparent !important; border-bottom: 1px solid #f3f4f6 !important; }
    
    /* DEFAULT STATE (No Image) */
    .file-drop-zone {
        background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%23E5E7EBFF' stroke-width='2' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
        transition: all 0.3s ease;
        background-color: #F9FAFB;
    }
    .file-drop-zone:hover {
        /* Hover: Solid Black Dashes */
        background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%23000000' stroke-width='2' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
        background-color: #F3F4F6;
    }

    /* PREVIEW STATE */
    .has-preview .file-drop-zone {
        background-image: none !important; 
        background-color: rgba(0, 0, 0, 0) !important;
        opacity: 0;
    }
    .has-preview .file-drop-zone:hover {
        background-color: rgba(0, 0, 0, 0.6) !important; 
        opacity: 1;
        backdrop-filter: blur(2px);
    }
    .has-preview .upload-icon { color: white !important; background-color: rgba(255,255,255,0.2) !important; }
    .has-preview .upload-text-label { color: white !important; }
    .file-drop-zone.error-flash {
        background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%23EF4444' stroke-width='2' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
        background-color: #FEF2F2 !important; opacity: 1 !important;
    }
</style>

<form id="blog-form" class="relative" data-mode="<%= locals.blog ? 'edit' : 'add' %>" data-id="<%= locals.blog ? blog._id : '' %>">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 lg:gap-12 items-start">
        
        <div class="lg:col-span-2 space-y-6">
            <div class="group">
                <input type="text" id="title" name="title" placeholder="Title of your story..." 
                    value="<%= locals.blog ? blog.title : '' %>"
                    class="w-full text-3xl md:text-5xl font-extrabold text-gray-900 placeholder-gray-300 border-none bg-transparent focus:ring-0 p-0 transition-all leading-tight" required>
                <div class="h-1 w-20 bg-gray-100 mt-4 group-focus-within:bg-black group-focus-within:w-full transition-all duration-500 rounded-full"></div>
            </div>

            <div class="min-h-[500px] text-lg text-gray-600">
                <textarea id="body" name="body" class="w-full h-full opacity-0"><%= locals.blog ? blog.body : '' %></textarea>
            </div>
        </div>

        <div class="lg:col-span-1 space-y-6 lg:sticky lg:top-32">
            <div class="bg-white p-6 rounded-[2rem] soft-glow border border-gray-100 space-y-6">
                <div class="flex items-center justify-between pb-4 border-b border-gray-50">
                    <h3 class="text-lg font-bold text-gray-900">Publishing</h3>
                    <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Settings</span>
                </div>

                <div class="space-y-2">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wide ml-1">URL Slug</label>
                    <div class="flex items-center px-4 py-3 bg-gray-50 rounded-xl border border-gray-200 focus-within:border-black transition-all">
                        <span class="text-gray-400 text-sm mr-1">/blog/</span>
                        <input type="text" id="slug" name="slug" placeholder="post-title" 
                            value="<%= locals.blog ? blog.urlSlug : '' %>"
                            class="w-full bg-transparent border-none text-sm font-medium text-gray-700 focus:ring-0 p-0 placeholder-gray-400">
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wide ml-1">Cover Image <span class="text-red-500">*</span></label>
                    
                    <div id="image-container" class="relative w-full aspect-video rounded-2xl overflow-hidden bg-gray-50 group <%= locals.blog && locals.blog.coverImageURL ? 'has-preview' : '' %>">
                        <img id="image-preview" src="<%= locals.blog ? blog.coverImageURL : '' %>" class="absolute inset-0 w-full h-full object-cover <%= locals.blog ? '' : 'hidden' %> z-10">
                        <label for="coverImage" class="file-drop-zone absolute inset-0 flex flex-col items-center justify-center cursor-pointer z-20">
                            <div id="upload-text" class="text-center p-4">
                                <div class="upload-icon w-10 h-10 bg-white rounded-full shadow-sm flex items-center justify-center mx-auto mb-2 text-black">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                </div>
                                <span class="upload-text-label text-xs font-medium text-gray-500"><%= locals.blog ? 'Change Cover' : 'Upload Cover' %></span>
                            </div>
                        </label>
                        <input type="file" id="coverImage" name="coverImage" accept="image/*" class="hidden">
                    </div>
                </div>

                <div class="pt-4 flex flex-col gap-3">
                    <button type="button" id="publish-btn" class="w-full py-4 bg-gray-900 hover:bg-black text-white font-bold rounded-xl shadow-lg transition-all transform active:scale-[0.98]">
                        <%= locals.blog ? 'Update & Publish' : 'Publish Story' %>
                    </button>
                    <button type="button" id="draft-btn" class="w-full py-4 bg-white border border-gray-200 text-gray-600 font-bold rounded-xl hover:bg-gray-50 transition-colors">
                        Save as Draft
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>

<div id="toast" class="fixed bottom-5 right-5 z-50 transform translate-y-20 opacity-0 transition-all duration-300 w-[calc(100%-2.5rem)] md:w-auto">
    <div class="bg-white border-l-4 border-gray-900 text-gray-800 px-6 py-4 rounded shadow-2xl flex items-center gap-4">
        <span id="toast-msg" class="font-medium">Notification</span>
    </div>
</div>

<script>
    const DRAFT_KEY = 'blog_autosave_data';
    const FORM_MODE = document.getElementById('blog-form').dataset.mode;

    // --- DEBOUNCED AUTOSAVE ---
    let saveTimeout;
    function silentAutoSave() {
        if (FORM_MODE !== 'add') return;
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            const titleVal = document.getElementById('title').value;
            const editor = tinymce.get('body');
            const bodyVal = editor ? editor.getContent() : '';
            if (titleVal || bodyVal) {
                localStorage.setItem(DRAFT_KEY, JSON.stringify({ title: titleVal, body: bodyVal }));
                console.log("Draft saved silently...");
            }
        }, 1000);
    }

    function restoreDraft(editor) {
        if (FORM_MODE !== 'add') return;
        const saved = localStorage.getItem(DRAFT_KEY);
        if (saved) {
            try {
                const data = JSON.parse(saved);
                if (data.title) {
                    document.getElementById('title').value = data.title;
                    document.getElementById('title').dispatchEvent(new Event('input'));
                }
                if (data.body && editor) editor.setContent(data.body);
            } catch (e) { console.error("Restore error", e); }
        }
    }

    // --- TINYMCE INIT ---
    tinymce.init({
        selector: '#body', 
        height: 600, 
        menubar: true,
        branding: false,
        plugins: ['advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview', 'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen', 'insertdatetime', 'media', 'table', 'code', 'help', 'wordcount', 'codesample', 'quickbars', 'emoticons'],
        quickbars_insert_toolbar: false, 
        quickbars_selection_toolbar: 'bold italic underline | h2 h3 | blockquote',
        toolbar: 'undo redo | blocks | bold italic underline | alignleft aligncenter alignright | bullist numlist | link image media table codesample | fullscreen preview',
        content_style: `
            body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; font-size: 18px; line-height: 1.8; color: #374151; margin: 0; padding: 1rem; } 
            blockquote { border-left: 3px solid #000000; padding-left: 1rem; color: #4B5563; font-style: italic; } 
            img { max-width: 100%; height: auto; border-radius: 0.5rem; display: block; margin: 1em 0; } 
            p { margin: 0; padding-bottom: 1em; }
            @media (max-width: 640px) { body { font-size: 16px; padding: 0.5rem; } }
        `,
        skin: 'oxide', icons: 'default',
        setup: function(editor) {
            editor.on('init', () => restoreDraft(editor));
            editor.on('input change keyup SetContent', silentAutoSave);
        }
    });

    // --- FORM LISTENERS ---
    const titleInput = document.getElementById('title');
    const slugInput = document.getElementById('slug');
    const fileInput = document.getElementById('coverImage');
    const previewImg = document.getElementById('image-preview');
    const imageContainer = document.getElementById('image-container');
    const uploadLabel = document.querySelector('.upload-text-label');
    let compressedFile = null;

    titleInput.addEventListener('input', (e) => {
        const val = e.target.value;
        const slug = val.toLowerCase().replace(/[^a-z0-9\s-]/g, '').trim().replace(/\s+/g, '-');
        slugInput.value = slug;
        silentAutoSave(); 
    });

    fileInput.addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) {
            if (FORM_MODE !== 'edit') {
                compressedFile = null;
                previewImg.classList.add('hidden');
                imageContainer.classList.remove('has-preview');
                uploadLabel.innerText = "Upload Cover";
            }
            return;
        }
        previewImg.src = URL.createObjectURL(file);
        previewImg.classList.remove('hidden');
        imageContainer.classList.add('has-preview');
        uploadLabel.innerText = "Change Cover";
        document.querySelector('.file-drop-zone').classList.remove('error-flash');

        try {
            // === UPDATED COMPRESSION SETTINGS FOR HIGH QUALITY ===
            const options = { 
                maxSizeMB: 1,           // Increased to 1MB (was 0.15)
                maxWidthOrHeight: 1920, // Full HD (was 1280)
                useWebWorker: true, 
                fileType: 'image/webp',
                initialQuality: 0.85    // Keep 85% Quality
            };
            compressedFile = await imageCompression(file, options);
        } catch (error) { 
            console.error("Compression failed, using original", error);
            compressedFile = file; 
        }
    });

    async function handleSubmission(statusType, clickedBtn) {
        tinymce.triggerSave();
        const titleVal = titleInput.value.trim();
        const bodyVal = document.getElementById('body').value.trim();
        const isEdit = FORM_MODE === 'edit';

        if (!titleVal || !bodyVal) return showToast('Title and Content are required', true);
        if (!isEdit && !compressedFile) {
            showToast('Cover image is required', true);
            imageContainer.querySelector('.file-drop-zone').classList.add('error-flash');
            return;
        }

        clickedBtn.disabled = true;
        const originalText = clickedBtn.innerText;
        clickedBtn.innerText = "Processing...";

        const formData = new FormData();
        formData.append('title', titleVal);
        formData.append('slug', slugInput.value);
        formData.append('status', statusType);
        formData.append('body', bodyVal);
        if (compressedFile) formData.append('coverImage', compressedFile, `${slugInput.value}.webp`);

        try {
            const url = isEdit ? `/blog/edit/${document.getElementById('blog-form').dataset.id}` : '/blog/add-blog';
            const res = await fetch(url, { method: 'POST', body: formData, headers: { 'Accept': 'application/json' } });
            const data = await res.json();
            
            if (res.ok) {
                if (FORM_MODE === 'add') localStorage.removeItem(DRAFT_KEY);
                window.location.href = data.redirect;
            } else throw new Error(data.error || 'Failed to save');
        } catch (err) {
            showToast(err.message, true);
            clickedBtn.disabled = false;
            clickedBtn.innerText = originalText;
        }
    }

    document.getElementById('publish-btn').addEventListener('click', (e) => handleSubmission('active', e.target));
    document.getElementById('draft-btn').addEventListener('click', (e) => handleSubmission('draft', e.target));

    function showToast(msg, isError) {
        const toast = document.getElementById('toast');
        document.getElementById('toast-msg').innerText = msg;
        toast.classList.remove('translate-y-20', 'opacity-0');
        const box = toast.querySelector('div');
        box.classList.toggle('border-gray-900', !isError);
        box.classList.toggle('border-red-500', isError);
        setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
    }
</script>